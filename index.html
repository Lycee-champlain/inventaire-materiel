<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Inventaire Collaboratif - Lyc√©e Champlain</title>
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e40af">
    
    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inventaire Collaboratif">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            padding-top: max(1rem, env(safe-area-inset-top));
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .counter {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .header-info {
            font-size: 0.85rem;
            opacity: 0.9;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .user-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .user-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sync Banner */
        .sync-banner {
            display: none;
            background: var(--success);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        }

        .sync-banner.show {
            display: block;
        }

        .sync-banner.warning {
            background: var(--warning);
        }

        .sync-banner.error {
            background: var(--danger);
        }

        /* Container */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Success message */
        .success-message {
            display: none;
            background: var(--success);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
            animation: slideDown 0.3s ease-out;
        }

        .success-message.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Form Card */
        .form-card {
            background: var(--card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .form-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .inventory-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .inventory-preview {
            display: none;
            background: var(--bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            border: 2px dashed var(--primary);
        }

        .inventory-preview.show {
            display: block;
        }

        .conflict-warning {
            display: none;
            background: var(--warning);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            text-align: center;
        }

        .conflict-warning.show {
            display: block;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            -webkit-appearance: none;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-input.large {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .quick-btn {
            padding: 0.625rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:active {
            transform: scale(0.98);
        }

        .quick-btn.selected {
            border-color: var(--primary);
            background: rgba(30, 64, 175, 0.1);
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
            margin-top: 0.5rem;
        }

        .btn-copy {
            background: var(--warning);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Liste des √©quipements */
        .saved-list {
            margin-top: 1.5rem;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .list-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .equipment-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--success);
        }

        .equipment-item.new {
            animation: highlight 1s ease-out;
        }

        @keyframes highlight {
            0% { background: #fef3c7; }
            100% { background: white; }
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .item-number {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .item-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .item-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--bg);
            color: var(--text-light);
        }

        .item-user {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .item-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .item-main {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: var(--text-light);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Navigation par salle */
        .view-mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .view-mode-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text);
        }

        .view-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .room-group {
            margin-bottom: 1.5rem;
        }

        .room-header {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .room-header:hover {
            background: var(--primary-light);
        }

        .room-count {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .room-items {
            display: block;
        }

        .room-items.collapsed {
            display: none;
        }

        /* Modal pour nom d'utilisateur */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 1rem;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-text {
            color: var(--text-light);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        @media (max-width: 640px) {
            .header h1 {
                font-size: 1rem;
            }
            
            .form-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sync Banner -->
    <div class="sync-banner" id="syncBanner"></div>

    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <h1>üì¶ Inventaire Collaboratif</h1>
            <div class="counter" id="counter">0 total</div>
        </div>
        <div class="header-info">
            <span id="currentDate"></span>
            <span id="syncStatus">üîÑ Sync...</span>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            ‚úÖ √âquipement enregistr√© !
        </div>

        <!-- Form Card -->
        <div class="form-card">
            <div class="form-header">
                <div class="form-title" id="formTitle">Nouvel √©quipement</div>
                <div class="inventory-number" id="inventoryNumber">---</div>
                <div class="inventory-preview" id="inventoryPreview"></div>
                <div class="conflict-warning" id="conflictWarning">
                    ‚ö†Ô∏è Ce num√©ro existe d√©j√† ! Actualisation...
                </div>
            </div>

            <form id="inventoryForm">
                <!-- Salle -->
                <div class="form-group">
                    <label class="form-label">
                        Salle <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        class="form-input large" 
                        id="inputSalle" 
                        placeholder="Ex: B201"
                        autocomplete="off"
                        required
                    >
                </div>

                <!-- Type d'√©quipement -->
                <div class="form-group">
                    <label class="form-label">
                        Type d'√©quipement <span class="required">*</span>
                    </label>
                    <div class="quick-actions">
                        <button type="button" class="quick-btn" data-type="Ordinateur">üíª Ordinateur</button>
                        <button type="button" class="quick-btn" data-type="Projecteur">üìΩÔ∏è Projecteur</button>
                        <button type="button" class="quick-btn" data-type="ENI">üñ•Ô∏è ENI</button>
                        <button type="button" class="quick-btn" data-type="Autre">üì¶ Autre</button>
                    </div>
                    <input type="hidden" id="inputType" required>
                </div>

                <!-- Marque -->
                <div class="form-group">
                    <label class="form-label">Marque</label>
                    <select class="form-select" id="inputMarque">
                        <option value="">-- S√©lectionner --</option>
                        <option value="Lenovo">Lenovo</option>
                        <option value="HP">HP</option>
                        <option value="Epson">Epson</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>

                <!-- Mod√®le -->
                <div class="form-group">
                    <label class="form-label">Mod√®le</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="inputModele" 
                        placeholder="Ex: OptiPlex 7080"
                        autocomplete="off"
                    >
                </div>

                <!-- Num√©ro de s√©rie -->
                <div class="form-group">
                    <label class="form-label">Num√©ro de s√©rie</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="inputSerie" 
                        placeholder="Ex: SN123456"
                        autocomplete="off"
                    >
                </div>

                <!-- Fin de garantie -->
                <div class="form-group">
                    <label class="form-label">
                        Fin de garantie <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="inputGarantie" 
                        placeholder="MM/AAAA (ex: 12/2026)"
                        maxlength="7"
                        autocomplete="off"
                        required
                    >
                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                        üìÖ Format : MM/AAAA (mois/ann√©e)
                    </div>
                </div>

                <!-- √âtat -->
                <div class="form-group">
                    <label class="form-label">
                        √âtat <span class="required">*</span>
                    </label>
                    <div class="quick-actions">
                        <button type="button" class="quick-btn selected" data-etat="OK">‚úÖ En service</button>
                        <button type="button" class="quick-btn" data-etat="Maintenance">‚ö†Ô∏è Maintenance</button>
                        <button type="button" class="quick-btn" data-etat="HS">‚ùå Hors service</button>
                    </div>
                    <input type="hidden" id="inputEtat" value="OK" required>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">Notes / Observations</label>
                    <textarea 
                        class="form-textarea" 
                        id="inputNotes" 
                        placeholder="Remarques, probl√®mes constat√©s..."
                    ></textarea>
                </div>

                <!-- Buttons -->
                <button type="submit" class="btn btn-primary" id="btnSave">
                    <span id="btnSaveText">üíæ Enregistrer</span>
                </button>
                
                <button type="button" class="btn btn-secondary" id="btnCancel" style="display: none; background: #6b7280; color: white; border: none;">
                    ‚ùå Annuler
                </button>
                
                <button type="button" class="btn btn-secondary" id="btnViewAll">
                    üìã Voir tout (0)
                </button>
            </form>
        </div>

        <!-- Saved Items List -->
        <div class="saved-list" id="savedList" style="display: none;">
            <div class="list-header">
                <div class="list-title">Tous les √©quipements</div>
                <button class="refresh-btn" id="btnRefresh">
                    üîÑ <span id="refreshText">Actualiser</span>
                </button>
            </div>
            
            <!-- Mode d'affichage -->
            <div class="view-mode-toggle">
                <button class="view-mode-btn active" data-view="room">üìç Par salle</button>
                <button class="view-mode-btn" data-view="all">üìã Vue brute</button>
            </div>
            
            <div id="equipmentList">
                <div class="loading show">
                    <div class="spinner"></div>
                    <p>Chargement...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJqvGhLGY4wx44kpTXF-7kYqWfA532MQYe8DlfLtql_mS2T-Qqlnlz882HNZIsDnID/exec';
        const SYNC_INTERVAL = 30000; // 30 secondes (optimis√© pour quotas Google)
        const ROOM_CHECK_INTERVAL = 30000; // 30 secondes
        
        // √âtat
        let allEquipment = [];
        let userName = 'Lyc√©e Champlain'; // Nom par d√©faut, pas d'identification
        let currentRoomPrefix = '';
        let currentRoomCount = 0;
        let lastSyncTimestamp = null;
        let syncIntervalId = null;
        let roomCheckIntervalId = null;
        let viewMode = 'room'; // 'room' ou 'all'
        let editMode = false; // Mode √©dition
        let editingItemId = null; // ID de l'item en cours d'√©dition

        // √âl√©ments DOM
        const form = document.getElementById('inventoryForm');
        const formTitle = document.getElementById('formTitle');
        const inputSalle = document.getElementById('inputSalle');
        const inputType = document.getElementById('inputType');
        const inputMarque = document.getElementById('inputMarque');
        const inputModele = document.getElementById('inputModele');
        const inputSerie = document.getElementById('inputSerie');
        const inputGarantie = document.getElementById('inputGarantie');
        const inputEtat = document.getElementById('inputEtat');
        const inputNotes = document.getElementById('inputNotes');
        const inventoryNumber = document.getElementById('inventoryNumber');
        const inventoryPreview = document.getElementById('inventoryPreview');
        const conflictWarning = document.getElementById('conflictWarning');
        const counter = document.getElementById('counter');
        const btnSave = document.getElementById('btnSave');
        const btnCancel = document.getElementById('btnCancel');
        const btnViewAll = document.getElementById('btnViewAll');
        const btnRefresh = document.getElementById('btnRefresh');
        const savedList = document.getElementById('savedList');
        const equipmentList = document.getElementById('equipmentList');
        const successMessage = document.getElementById('successMessage');
        const syncBanner = document.getElementById('syncBanner');
        const modalUser = document.getElementById('modalUser');

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            // D√©marrer directement sans modal d'identification
            init();
        });

        function init() {
            updateDate();
            setupEventListeners();
            registerServiceWorker();
            startSyncInterval();
            syncData();
        }

        // Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/service-worker.js');
                } catch (error) {
                    console.error('Service Worker error:', error);
                }
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Salle change
            inputSalle.addEventListener('input', debounce(updateInventoryNumber, 300));
            
            // Garantie auto-formatage
            inputGarantie.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length >= 2) {
                    value = value.slice(0, 2) + '/' + value.slice(2, 6);
                }
                e.target.value = value;
            });
            
            // Quick type buttons
            document.querySelectorAll('[data-type]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    inputType.value = this.dataset.type;
                });
            });

            // Quick √©tat buttons
            document.querySelectorAll('[data-etat]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-etat]').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    inputEtat.value = this.dataset.etat;
                });
            });

            // Form submit
            form.addEventListener('submit', saveEquipment);

            // View all
            btnViewAll.addEventListener('click', toggleList);

            // Refresh
            btnRefresh.addEventListener('click', () => syncData(true));
            
            // Cancel edit
            btnCancel.addEventListener('click', cancelEdit);
            
            // View mode toggle
            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    viewMode = this.dataset.view;
                    updateList();
                });
            });
        }

        // Synchronisation automatique
        function startSyncInterval() {
            syncIntervalId = setInterval(() => {
                syncData(false);
            }, SYNC_INTERVAL);
        }

        // Synchronisation des donn√©es
        async function syncData(showMessage = false) {
            try {
                document.getElementById('syncStatus').textContent = 'üîÑ Sync...';
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll&t=${Date.now()}`);
                const result = await response.json();
                
                if (result.success) {
                    const previousCount = allEquipment.length;
                    allEquipment = result.data || [];
                    lastSyncTimestamp = Date.now();
                    
                    updateCounter();
                    updateList();
                    
                    document.getElementById('syncStatus').textContent = '‚úÖ Sync OK';
                    
                    // D√©tecter nouvelles saisies
                    if (showMessage && allEquipment.length > previousCount) {
                        const newCount = allEquipment.length - previousCount;
                        showBanner(`‚úÖ ${newCount} nouvel(aux) √©quipement(s) charg√©(s)`, 'success');
                    }
                    
                    // V√©rifier si le num√©ro actuel existe d√©j√†
                    checkCurrentNumberConflict();
                } else {
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Erreur';
                }
            } catch (error) {
                console.error('Sync error:', error);
                document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Hors ligne';
            }
        }

        // V√©rifier conflit de num√©rotation
        function checkCurrentNumberConflict() {
            if (!currentRoomPrefix) return;
            
            const currentNumber = `${currentRoomPrefix}-${String(currentRoomCount).padStart(3, '0')}`;
            const exists = allEquipment.some(item => item['Num√©ro Inventaire'] === currentNumber);
            
            if (exists) {
                conflictWarning.classList.add('show');
                // Recalculer le num√©ro
                currentRoomCount = getNextRoomNumber(currentRoomPrefix);
                updateInventoryNumber();
                
                setTimeout(() => {
                    conflictWarning.classList.remove('show');
                }, 3000);
            }
        }

        // Mise √† jour du num√©ro d'inventaire
        async function updateInventoryNumber() {
            const salle = inputSalle.value.trim().toUpperCase();
            
            if (!salle) {
                inventoryNumber.textContent = '---';
                inventoryPreview.classList.remove('show');
                return;
            }

            // Si changement de salle, r√©cup√©rer le prochain num√©ro du serveur
            if (salle !== currentRoomPrefix) {
                currentRoomPrefix = salle;
                
                try {
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getNextNumber&room=${encodeURIComponent(salle)}&t=${Date.now()}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        currentRoomCount = result.nextNumber;
                    } else {
                        // Fallback local
                        currentRoomCount = getNextRoomNumber(salle);
                    }
                } catch (error) {
                    // Fallback local
                    currentRoomCount = getNextRoomNumber(salle);
                }
            }

            const numero = `${salle}-${String(currentRoomCount).padStart(3, '0')}`;
            inventoryNumber.textContent = numero;
            inventoryPreview.textContent = `N¬∞ Inventaire : ${numero}`;
            inventoryPreview.classList.add('show');
        }

        // Obtenir le prochain num√©ro (calcul local)
        function getNextRoomNumber(salle) {
            const roomItems = allEquipment.filter(item => 
                item['Num√©ro Inventaire'] && item['Num√©ro Inventaire'].startsWith(salle + '-')
            );
            
            if (roomItems.length === 0) return 1;

            const numbers = roomItems.map(item => {
                const parts = item['Num√©ro Inventaire'].split('-');
                return parseInt(parts[parts.length - 1]);
            });

            return Math.max(...numbers) + 1;
        }

        // Sauvegarde d'un √©quipement
        async function saveEquipment(e) {
            e.preventDefault();

            if (!inputType.value) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un type d\'√©quipement');
                return;
            }

            // Validation format garantie MM/AAAA
            const garantieValue = inputGarantie.value.trim();
            const garantieRegex = /^(0[1-9]|1[0-2])\/\d{4}$/;
            if (!garantieRegex.test(garantieValue)) {
                alert('‚ö†Ô∏è Format de garantie invalide\nUtilisez le format MM/AAAA (ex: 12/2026)');
                inputGarantie.focus();
                return;
            }

            btnSave.disabled = true;

            if (editMode && editingItemId) {
                // MODE √âDITION - Update
                await updateEquipment();
            } else {
                // MODE CR√âATION - Add
                await createEquipment();
            }

            btnSave.disabled = false;
        }

        // Cr√©er un nouvel √©quipement
        async function createEquipment() {
            const salle = inputSalle.value.trim().toUpperCase();
            const numero = `${salle}-${String(currentRoomCount).padStart(3, '0')}`;

            // V√©rifier une derni√®re fois que le num√©ro n'existe pas
            const exists = allEquipment.some(item => item['Num√©ro Inventaire'] === numero);
            if (exists) {
                showBanner('‚ö†Ô∏è Ce num√©ro existe d√©j√† ! Actualisation...', 'warning');
                await syncData();
                currentRoomCount = getNextRoomNumber(salle);
                updateInventoryNumber();
                return;
            }

            const equipment = {
                id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                numeroInventaire: numero,
                salle: salle,
                type: inputType.value,
                marque: inputMarque.value.trim(),
                modele: inputModele.value.trim(),
                numeroSerie: inputSerie.value.trim(),
                finGarantie: inputGarantie.value.trim(),
                etat: inputEtat.value,
                notes: inputNotes.value.trim(),
                dateCreation: new Date().toISOString(),
                operateur: userName
            };

            btnSave.innerHTML = '<span>üíæ Enregistrement...</span>';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'add',
                        data: equipment
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage();
                    showBanner(`‚úÖ ${numero} enregistr√© !`, 'success');
                    
                    // Recharger imm√©diatement
                    await syncData();
                    
                    // Pr√©parer pour le prochain
                    resetFormForNext();
                } else {
                    alert('‚ùå Erreur : ' + (result.error || '√âchec de sauvegarde'));
                    // Recharger pour v√©rifier l'√©tat
                    await syncData();
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå Erreur de connexion. V√©rifiez votre r√©seau.');
            } finally {
                btnSave.innerHTML = '<span>üíæ Enregistrer</span>';
            }
        }

        // Mettre √† jour un √©quipement existant
        async function updateEquipment() {
            const item = allEquipment.find(eq => eq['ID'] === editingItemId);
            if (!item) {
                alert('‚ùå √âquipement introuvable');
                return;
            }

            const updatedEquipment = {
                id: editingItemId,
                numeroInventaire: item['Num√©ro Inventaire'], // Le num√©ro ne change pas
                salle: inputSalle.value.trim().toUpperCase(),
                type: inputType.value,
                marque: inputMarque.value.trim(),
                modele: inputModele.value.trim(),
                numeroSerie: inputSerie.value.trim(),
                finGarantie: inputGarantie.value.trim(),
                etat: inputEtat.value,
                notes: inputNotes.value.trim(),
                dateCreation: item['Date Cr√©ation'] || new Date().toISOString(),
                operateur: userName
            };

            btnSave.innerHTML = '<span>üíæ Mise √† jour...</span>';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'update',
                        id: editingItemId,
                        data: updatedEquipment
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showBanner(`‚úÖ ${item['Num√©ro Inventaire']} mis √† jour !`, 'success');
                    
                    // Recharger
                    await syncData();
                    
                    // Sortir du mode √©dition
                    cancelEdit();
                } else {
                    alert('‚ùå Erreur : ' + (result.error || '√âchec de mise √† jour'));
                    await syncData();
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('‚ùå Erreur de connexion. V√©rifiez votre r√©seau.');
            } finally {
                btnSave.innerHTML = '<span>üíæ Enregistrer</span>';
            }
        }

        // Reset form
        function resetFormForNext() {
            inputType.value = '';
            inputMarque.value = '';
            inputModele.value = '';
            inputSerie.value = '';
            inputNotes.value = '';
            // Ne pas r√©initialiser inputGarantie pour faciliter la saisie en s√©rie
            
            document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('selected'));
            
            inputEtat.value = 'OK';
            document.querySelectorAll('[data-etat]').forEach(b => b.classList.remove('selected'));
            document.querySelector('[data-etat="OK"]').classList.add('selected');

            currentRoomCount++;
            updateInventoryNumber();

            window.scrollTo(0, 0);
        }

        // Messages
        function showSuccessMessage() {
            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 2000);
        }

        function showBanner(message, type = 'success') {
            syncBanner.textContent = message;
            syncBanner.className = 'sync-banner show';
            if (type === 'warning') syncBanner.classList.add('warning');
            if (type === 'error') syncBanner.classList.add('error');
            
            setTimeout(() => {
                syncBanner.classList.remove('show');
            }, 3000);
        }

        // Update counter
        function updateCounter() {
            const count = allEquipment.length;
            counter.textContent = `${count} total`;
            btnViewAll.innerHTML = `üìã Voir tout (${count})`;
        }

        // Update date
        function updateDate() {
            const now = new Date();
            const options = { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
        }

        // Toggle list
        function toggleList() {
            if (savedList.style.display === 'none') {
                savedList.style.display = 'block';
                updateList();
                btnViewAll.textContent = '‚¨ÜÔ∏è Masquer';
            } else {
                savedList.style.display = 'none';
                btnViewAll.innerHTML = `üìã Voir tout (${allEquipment.length})`;
            }
        }

        // Update list
        function updateList() {
            if (allEquipment.length === 0) {
                equipmentList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <p>Aucun √©quipement</p>
                    </div>
                `;
                return;
            }

            if (viewMode === 'room') {
                // Vue group√©e par salle
                renderRoomView();
            } else {
                // Vue brute (liste compl√®te)
                renderAllView();
            }
        }

        // Vue par salle
        function renderRoomView() {
            // Grouper par salle
            const roomGroups = {};
            allEquipment.forEach(item => {
                const room = item['Salle'];
                if (!roomGroups[room]) {
                    roomGroups[room] = [];
                }
                roomGroups[room].push(item);
            });

            // Trier les salles alphab√©tiquement
            const sortedRooms = Object.keys(roomGroups).sort();

            equipmentList.innerHTML = sortedRooms.map(room => {
                const items = roomGroups[room];
                
                // Trier les items par num√©ro d'inventaire
                items.sort((a, b) => {
                    const numA = parseInt(a['Num√©ro Inventaire'].split('-').pop());
                    const numB = parseInt(b['Num√©ro Inventaire'].split('-').pop());
                    return numA - numB;
                });

                return `
                    <div class="room-group">
                        <div class="room-header" onclick="toggleRoom('${room}')">
                            <span>üìç ${room}</span>
                            <span class="room-count">${items.length}</span>
                        </div>
                        <div class="room-items" id="room-${room}">
                            ${items.map(item => renderEquipmentItem(item)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Vue brute (tous les √©quipements)
        function renderAllView() {
            // Trier par date d√©croissante
            const sorted = [...allEquipment].sort((a, b) => {
                const dateA = new Date(a['Derni√®re Sync'] || a['Date Cr√©ation'] || 0);
                const dateB = new Date(b['Derni√®re Sync'] || b['Date Cr√©ation'] || 0);
                return dateB - dateA;
            });

            equipmentList.innerHTML = sorted.map(item => renderEquipmentItem(item)).join('');
        }

        // Rendu d'un item d'√©quipement
        function renderEquipmentItem(item) {
            const isRecent = (Date.now() - new Date(item['Derni√®re Sync'] || item['Date Cr√©ation'])) < 60000;
            const garantie = formatGarantie(item['Fin Garantie']);
            
            return `
                <div class="equipment-item ${isRecent ? 'new' : ''}">
                    <div class="item-header">
                        <div class="item-number">${item['Num√©ro Inventaire']}</div>
                        <div class="item-meta">
                            <div class="item-badge">${item['√âtat']}</div>
                        </div>
                    </div>
                    <div class="item-main">${getIcon(item['Type'])} ${item['Type']} - ${item['Salle']}</div>
                    <div class="item-details">
                        ${item['Marque'] ? item['Marque'] + ' ' : ''}${item['Mod√®le'] ? item['Mod√®le'] : ''}
                        ${item['Num√©ro S√©rie'] ? ' ‚Ä¢ S/N: ' + item['Num√©ro S√©rie'] : ''}
                        <br>üìÖ Garantie: ${garantie}
                    </div>
                    <div class="item-actions" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e2e8f0; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn-copy" onclick="editEquipment('${item['ID']}')">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button class="btn-copy" onclick="copyEquipment('${item['ID']}')">
                            üìã Copier
                        </button>
                        <button class="btn btn-danger" style="background: #ef4444; color: white; padding: 0.5rem; font-size: 0.85rem; flex: 1;" onclick="deleteEquipment('${item['ID']}')">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
            `;
        }

        // Toggle affichage d'une salle
        function toggleRoom(room) {
            const roomItems = document.getElementById(`room-${room}`);
            if (roomItems) {
                roomItems.classList.toggle('collapsed');
            }
        }

        // Copier un √©quipement
        function copyEquipment(id) {
            const item = allEquipment.find(eq => eq['ID'] === id);
            if (!item) return;

            // Remplir le formulaire avec les donn√©es
            inputSalle.value = item['Salle'];
            
            // S√©lectionner le type
            const typeBtn = document.querySelector(`[data-type="${item['Type']}"]`);
            if (typeBtn) {
                document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('selected'));
                typeBtn.classList.add('selected');
                inputType.value = item['Type'];
            }
            
            inputMarque.value = item['Marque'] || '';
            inputModele.value = item['Mod√®le'] || '';
            inputSerie.value = ''; // On ne copie PAS le num√©ro de s√©rie
            inputGarantie.value = item['Fin Garantie'] || '';
            
            // S√©lectionner l'√©tat
            const etatBtn = document.querySelector(`[data-etat="${item['√âtat']}"]`);
            if (etatBtn) {
                document.querySelectorAll('[data-etat]').forEach(b => b.classList.remove('selected'));
                etatBtn.classList.add('selected');
                inputEtat.value = item['√âtat'];
            }
            
            inputNotes.value = item['Notes'] || '';

            // Mettre √† jour le num√©ro d'inventaire
            updateInventoryNumber();

            // Scroller vers le formulaire
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Masquer la liste
            savedList.style.display = 'none';
            btnViewAll.innerHTML = `üìã Voir tout (${allEquipment.length})`;
            
            showBanner('üìã √âquipement copi√© ! Modifiez et enregistrez.', 'success');
        }

        // √âditer un √©quipement
        function editEquipment(id) {
            const item = allEquipment.find(eq => eq['ID'] === id);
            if (!item) return;

            // Passer en mode √©dition
            editMode = true;
            editingItemId = id;

            // Modifier l'interface
            formTitle.textContent = '‚úèÔ∏è Modifier l\'√©quipement';
            inventoryNumber.textContent = item['Num√©ro Inventaire'];
            inventoryNumber.style.color = '#f59e0b'; // Orange pour indiquer mode √©dition
            btnSave.innerHTML = '<span>üíæ Mettre √† jour</span>';
            btnCancel.style.display = 'block';
            btnViewAll.style.display = 'none';

            // Remplir le formulaire avec TOUTES les donn√©es (y compris num√©ro de s√©rie)
            inputSalle.value = item['Salle'];
            inputSalle.disabled = true; // Emp√™cher de changer la salle (pour garder le num√©ro d'inventaire)
            
            // S√©lectionner le type
            const typeBtn = document.querySelector(`[data-type="${item['Type']}"]`);
            if (typeBtn) {
                document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('selected'));
                typeBtn.classList.add('selected');
                inputType.value = item['Type'];
            }
            
            inputMarque.value = item['Marque'] || '';
            inputModele.value = item['Mod√®le'] || '';
            inputSerie.value = item['Num√©ro S√©rie'] || '';
            inputGarantie.value = item['Fin Garantie'] || '';
            
            // S√©lectionner l'√©tat
            const etatBtn = document.querySelector(`[data-etat="${item['√âtat']}"]`);
            if (etatBtn) {
                document.querySelectorAll('[data-etat]').forEach(b => b.classList.remove('selected'));
                etatBtn.classList.add('selected');
                inputEtat.value = item['√âtat'];
            }
            
            inputNotes.value = item['Notes'] || '';

            // Scroller vers le formulaire
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Masquer la liste
            savedList.style.display = 'none';
            btnViewAll.innerHTML = `üìã Voir tout (${allEquipment.length})`;
            
            showBanner('‚úèÔ∏è Mode √©dition activ√©', 'warning');
        }

        // Annuler l'√©dition
        function cancelEdit() {
            editMode = false;
            editingItemId = null;

            // Restaurer l'interface normale
            formTitle.textContent = 'Nouvel √©quipement';
            inventoryNumber.style.color = '';
            btnSave.innerHTML = '<span>üíæ Enregistrer</span>';
            btnCancel.style.display = 'none';
            btnViewAll.style.display = 'block';
            inputSalle.disabled = false;

            // R√©initialiser le formulaire
            resetFormForNext();
            
            showBanner('‚ùå √âdition annul√©e', 'warning');
        }

        // Helpers
        function formatGarantie(garantie) {
            if (!garantie) return 'Non renseign√©e';
            
            // Si c'est d√©j√† au format MM/AAAA
            if (typeof garantie === 'string' && /^\d{2}\/\d{4}$/.test(garantie)) {
                return garantie;
            }
            
            // Si c'est une date ISO ou un objet Date
            try {
                const date = new Date(garantie);
                if (!isNaN(date.getTime())) {
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${month}/${year}`;
                }
            } catch (e) {
                // Ignorer les erreurs
            }
            
            // Si c'est un string avec d'autres formats, essayer d'extraire
            if (typeof garantie === 'string') {
                // Format potentiel : "2027-08-31T22:00:00.000Z"
                const match = garantie.match(/(\d{4})-(\d{2})/);
                if (match) {
                    const year = match[1];
                    const month = match[2];
                    return `${month}/${year}`;
                }
            }
            
            return 'Non renseign√©e';
        }
        
        function getIcon(type) {
            const icons = {
                'Ordinateur': 'üíª',
                'Projecteur': 'üìΩÔ∏è',
                'ENI': 'üñ•Ô∏è',
                'Autre': 'üì¶'
            };
            return icons[type] || 'üì¶';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Supprimer un √©quipement
        async function deleteEquipment(id) {
            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer cet √©quipement ?\n\nCette action est irr√©versible.')) {
                return;
            }

            try {
                showBanner('üóëÔ∏è Suppression en cours...', 'warning');

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        id: id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showBanner('‚úÖ √âquipement supprim√© !', 'success');
                    // Recharger imm√©diatement
                    await syncData(false);
                    updateList();
                } else {
                    showBanner('‚ùå Erreur : ' + (result.error || '√âchec de suppression'), 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showBanner('‚ùå Erreur de connexion', 'error');
            }
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (syncIntervalId) clearInterval(syncIntervalId);
            if (roomCheckIntervalId) clearInterval(roomCheckIntervalId);
        });
    </script>
</body>
</html>
